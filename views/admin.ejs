<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registration & Users List</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
        }

        .container {
            width: 80%;
            max-width: 1000px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .nav-links {
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-links button {
            padding: 10px 20px;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 8px;
            cursor: pointer;
        }

        .nav-links button:hover {
            background: #0056b3;
        }

        .register-form,
        .user-list-container {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            display: none;
        }

        .register-form.active,
        .user-list-container.active {
            display: block;
        }

        .register-form h2,
        .user-list-container h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
            position: relative;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        .form-group i {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #555;
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: #28a745;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        .submit-btn:hover {
            background-color: #218838;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 8px;
        }

        th {
            text-align: left;
            background: #eee;
        }

        .user-header {
            background: #007bff;
            color: white;
            padding: 10px;
            cursor: pointer;
        }

        .user-body {
            display: none;
            padding: 10px;
            background: #f9f9f9;
        }

        .delete-btn {
            background: red;
            color: white;
            float: right;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .save-btn {
            background: #28a745;
            color: white;
            border: none;
            margin-top: 10px;
            padding: 8px 15px;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <form class="logout-container" action="/logout" method="POST">
        <button type="submit" title="Log Out">ðŸšª Log Out</button>
    </form>

    <div class="container">
        <div class="nav-links">
            <button onclick="showSection('admin')">Sign Up Admin</button>
            <button onclick="showSection('user')">Sign Up User</button>
            <button onclick="showSection('list')">Users List</button>
        </div>

        <!-- Admin Form -->
        <form id="adminForm" class="register-form" onsubmit="submitForm(event, 'admin')">
            <h2><i class="fa fa-user-shield"></i> Sign Up Admin</h2>
            <div class="form-group">
                <input type="text" name="name" placeholder="Name" required>
                <i class="fa fa-id-badge"></i>
            </div>
            <div class="form-group">
                <input type="text" name="username" placeholder="Username" required>
                <i class="fa fa-user"></i>
            </div>
            <div class="form-group">
                <input type="password" name="password" placeholder="Password" required>
                <i class="fa fa-lock"></i>
            </div>
            <button class="submit-btn" type="submit"><i class="fa fa-paper-plane"></i> Submit</button>
        </form>

        <!-- User Form -->
        <form id="userForm" class="register-form" onsubmit="submitForm(event, 'user')">
            <h2><i class="fa fa-user-plus"></i> Sign Up User</h2>
            <div class="form-group">
                <input type="text" name="username" placeholder="Username" required>
                <i class="fa fa-user"></i>
            </div>
            <div class="form-group">
                <input type="password" name="password" placeholder="Password" required>
                <i class="fa fa-lock"></i>
            </div>
            <div class="form-group">
                <input type="number" name="credit" placeholder="Credit" required>
                <i class="fa fa-credit-card"></i>
            </div>
            <div class="form-group">
                <input type="number" name="user_Commission" placeholder="User Commission" required>
                <i class="fa fa-percent"></i>
            </div>
            <div class="form-group">
                <input type="number" name="owner_Commission" placeholder="Owner Commission" required>
                <i class="fa fa-percent"></i>
            </div>
            <button class="submit-btn" type="submit"><i class="fa fa-paper-plane"></i> Submit</button>
        </form>

        <!-- Users List -->
        <div id="userListContainer" class="user-list-container">
            <h2><i class="fa fa-users"></i> Users List</h2>
            <div id="userList"></div>
        </div>
    </div>

    <script>
        function showSection(section) {
            document.getElementById('adminForm').classList.remove('active');
            document.getElementById('userForm').classList.remove('active');
            document.getElementById('userListContainer').classList.remove('active');

            if (section === 'admin') {
                document.getElementById('adminForm').classList.add('active');
            } else if (section === 'user') {
                document.getElementById('userForm').classList.add('active');
            } else if (section === 'list') {
                document.getElementById('userListContainer').classList.add('active');
                fetchUsers(); // Only fetch when list is shown
            }
        }

        async function submitForm(event, role) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());

            const response = await fetch(`/signup/${role}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                alert(`${role.charAt(0).toUpperCase() + role.slice(1)} registered successfully.`);
                event.target.reset();
                if (role === 'user') fetchUsers();
            } else {
                alert('Error registering user.');
            }
        }

        async function fetchUsers() {
            const response = await fetch('/users_list');
            const users = await response.json();
            renderUserList(users);
        }

        function renderUserList(users) {
            const container = document.getElementById("userList");
            container.innerHTML = "";
            const excludedKeys = ["balance", "password", "games", "__v"];

            users.forEach((user, index) => {
                const wrapper = document.createElement("div");

                const header = document.createElement("div");
                header.className = "user-header";
                header.innerHTML = `
                        #${index + 1} - ${user.username}
                        ${user.name ? ` | Name: ${user.name}` : ""}
                        ${user.role ? ` | Role: ${user.role}` : ""}
                        <button class="delete-btn" onclick="deleteUser('${user._id}')">Delete</button>
                    `;

                const body = document.createElement("div");
                body.className = "user-body";

                const table = document.createElement("table");
                for (let key in user) {
                    if (!excludedKeys.includes(key)) {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                                <th>${key}</th>
                                <td><input type="text" name="${key}" value="${user[key]}"></td>
                            `;
                        table.appendChild(row);
                    }
                }

                const saveBtn = document.createElement("button");
                saveBtn.className = "save-btn";
                saveBtn.innerText = "Save";
                saveBtn.onclick = () => saveUserChanges(user._id, body.querySelectorAll("input"));

                body.appendChild(table);
                body.appendChild(saveBtn);

                header.onclick = () => {
                    body.style.display = (body.style.display === "block") ? "none" : "block";
                };

                wrapper.appendChild(header);
                wrapper.appendChild(body);
                container.appendChild(wrapper);
            });
        }

        async function saveUserChanges(userId, inputs) {
            const updatedUser = {};
            inputs.forEach(input => {
                updatedUser[input.name] = input.value;
            });

            await fetch(`/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedUser)
            });

            fetchUsers();
        }

        async function deleteUser(userId) {
            if (confirm("Are you sure you want to delete this user?")) {
                await fetch(`/users/${userId}`, { method: 'DELETE' });
                fetchUsers();
            }
        }

        // Optional: load list only if list section is shown
        window.onload = () => {
            if (document.getElementById('userListContainer').classList.contains('active')) {
                fetchUsers();
            }
        };
    </script>
    
</body>

</html>